import aubio
import numpy as np
import pyaudio
import time

# Initialize PyAudio
p = pyaudio.PyAudio()

# Open stream
stream = p.open(format=pyaudio.paFloat32,
                channels=1,
                rate=44100,
                input=True,
                frames_per_buffer=1024)

# Aubio's pitch detection
pDetection = aubio.pitch("default", 2048, 1024, 48000)

pDetection.set_unit("Hz")
pDetection.set_silence(-40)

# Time window for note input in seconds
input_window = 3

def get_note():
    data = stream.read(1024)
    samples = np.frombuffer(data, dtype=aubio.float_type)
    pitch = pDetection(samples)[0]
    # Convert frequency to musical note
    return aubio.freq2note(pitch)

expected_note = 'A4'  # Replace 'A4' with the expected note

while True:
    start_time = time.time()
    correct_note_detected = False

    while time.time() - start_time < input_window:
        detected_note = get_note()
        print(f"Detected Note: {detected_note}")

        if detected_note == expected_note:
            print("Correct note detected! Stopping.")
            correct_note_detected = True
            break  # Exit the inner loop if the correct note is detected

    if correct_note_detected:
        break  # Exit the outer loop and stop the program
    time.sleep(0)

# Stop and close the stream
stream.stop_stream()
stream.close()
p.terminate()
